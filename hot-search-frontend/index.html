<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çƒ­ç‚¹ä¸€è§ˆ</title>
    <link rel="icon" href="./icon/favicon.png">
    <link rel="stylesheet" href="index.css">

    <!-- å¼•å…¥element-uiæ ·å¼ -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- å¼•å…¥element-uiç»„ä»¶åº“ -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- å¼•å…¥axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- å¼•å…¥ Vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>

</head>

<body>
<!-- åˆ›å»ºä¸€ä¸ªæ ¹å…ƒç´  -->
<div class="home" id="home">
    <header>
        <!-- å¤©æ°”æ˜¾ç¤º -->
        <a href="#" target="_blank"  class="weather-link">
            <div class="weather-display">
                <span id="weather-city"></span>
                <span id="weather-icon"></span>
                <span id="weather-condition"></span>
                <span id="weather-temp"></span>
            </div>
        </a>
        <div class="time-display">
            <span id="beijing-time"></span>
            <span id="week-day"></span>
        </div>
        <!--åˆ‡æ¢ä¸»é¢˜-->
        <button id="theme-toggle" class="theme-toggle">
            <span id="theme-icon" @click="toggleTheme">ğŸŒ</span> <!-- é»˜è®¤æ˜¾ç¤ºå¤ªé˜³å›¾æ ‡ -->
        </button>
    </header>

    <div class="container">
        <div class="list-wrapper">
            <div class="hot-list-card" v-for="(platform, index) in platforms" :key="index">
                <div class="list-header">
                    <div class="logo" :class="platform.logoClass"></div>
                    <span class="list-title">{{ platform.name }}</span>
                </div>
                <div class="list-content">
                    <div v-if="platform.isLoading" class="loading">
                        æ•°æ®åŠ è½½ä¸­...
                    </div>
                    <div v-else-if="platform.error" class="error">
                        æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚
                    </div>
                    <div v-else>
                        <div class="list-item" v-for="(item, itemIndex) in platform.hotList" :key="itemIndex">
    <span class="rank" :class="{
        'top1': item.hotRank === 1,
        'top2': item.hotRank === 2,
        'top3': item.hotRank === 3
    }">{{ item.hotRank }}</span>
                            <a :href="item.hotUrl" target="_blank" class="item-title" :title="item.hotTitle">
                                {{ item.hotTitle.length > 30 ? item.hotTitle.substring(0, 30) + '...' : item.hotTitle }}
                            </a>
                            <span class="score">{{ formatHotValue(item.hotValue) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    window.onload = function () {
        vm.init();
        updateTime();
        setInterval(updateTime, 1000);
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ä¸»é¢˜è®¾ç½®
        checkLocalStorageTheme();
        // è·å–ç”¨æˆ·åœ°ç†ä½ç½®å¹¶æ˜¾ç¤ºå¤©æ°”
        getUserLocation();
    }

    function getUserLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    console.log('è·å–åœ°ç†ä½ç½®æˆåŠŸï¼š', latitude, longitude)
                    // å°†ç»çº¬åº¦è½¬æ¢ä¸ºadcode
                    getWeatherByAdcode(latitude, longitude);
                },
                error => {
                    console.error('è·å–åœ°ç†ä½ç½®å¤±è´¥', error);
                    // å¯ä»¥åœ¨è¿™é‡Œæä¾›ä¸€ä¸ªé»˜è®¤çš„åœ°ç†ä½ç½®æˆ–è€…æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
                }
            );
        } else {
            console.error('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®è·å–');
        }
    }

    function getWeatherByAdcode(latitude, longitude) {
        // è·å–adcode
        axios.get('http://117.72.117.19:9782/Weather/getWeather', {
            params: {
                latitude: latitude,
                longitude: longitude
            }
        })
            .then(response => {
                console.log('è§£æè¿”å›ï¼š', response)
                const weatherData = response.data.data;
                // æ›´æ–°å¤©æ°”æ˜¾ç¤º
                updateWeatherDisplay(weatherData);
            })
    }

    function updateWeatherDisplay(weatherData) {
        document.getElementById('weather-city').textContent = weatherData.city;
        document.getElementById('weather-icon').textContent = getWeatherIcon(weatherData.weather);
        document.getElementById('weather-condition').textContent = weatherData.weather;
        document.getElementById('weather-temp').textContent = weatherData.temperature + 'â„ƒ';

        // è®¾ç½®è·³è½¬é“¾æ¥
        const weatherLink = document.querySelector('.weather-link');
        weatherLink.href = `https://tianqi.qq.com/?province=${encodeURIComponent(weatherData.province)}&city=${encodeURIComponent(weatherData.city)}`;
    }

    // æ ¹æ®å¤©æ°”çŠ¶å†µè¿”å›å¯¹åº”çš„å›¾æ ‡
    function getWeatherIcon(condition) {
        const weatherIcons = {
            'æ™´': 'â˜€ï¸',
            'å¤šäº‘': 'â›…',
            'é˜´': 'â˜ï¸',
            'å°é›¨': 'ğŸŒ¦ï¸',
            'å¤§é›¨': 'ğŸŒ§ï¸',
            'é›ª': 'â„ï¸'
        };
        return weatherIcons[condition] || ''; // å¦‚æœæ²¡æœ‰åŒ¹é…çš„å›¾æ ‡ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
    }

    function updateTime() {
        const now = new Date();
        const beijingTime = now.toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'});
        document.getElementById('beijing-time').textContent = `${beijingTime}`;

        const weekDay = now.toLocaleString('zh-CN', {weekday: 'long'});
        document.getElementById('week-day').textContent = `${weekDay}`;
    }

    function checkLocalStorageTheme() {
        const savedTheme = localStorage.getItem('appTheme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
            document.getElementById('theme-icon').textContent = 'ğŸŒ™';
        }
    }

    // å°†vueæŒ‚è½½åˆ°idä¸ºhomeçš„æ ¹å…ƒç´ ä¸Š
    const vm = new Vue({
        el: '#home',
        data: {
            platforms: [
                {name: 'ç™¾åº¦çƒ­æ¦œ', logoClass: 'baidu-logo', hotList: [], type: 'baidu', isLoading: true, error: false},
                {
                    name: 'æŠ–éŸ³çƒ­æ¦œ',
                    logoClass: 'douyin-logo',
                    hotList: [],
                    type: 'douyin',
                    isLoading: true,
                    error: false
                },
                {name: 'çŸ¥ä¹çƒ­æ¦œ', logoClass: 'zhihu-logo', hotList: [], type: 'zhihu', isLoading: true, error: false},
                {
                    name: 'Bç«™çƒ­æ¦œ',
                    logoClass: 'bilibili-logo',
                    hotList: [],
                    type: 'bilibili',
                    isLoading: true,
                    error: false
                },
                {
                    name: 'æ˜é‡‘çƒ­æ¦œ',
                    logoClass: 'juejin-logo',
                    hotList: [],
                    type: 'juejin',
                    isLoading: true,
                    error: false
                },
                {
                    name: 'è…¾è®¯ç½‘çƒ­æ¦œ',
                    logoClass: 'tengxunwang-logo',
                    hotList: [],
                    type: 'tengxunwang',
                    isLoading: true,
                    error: false
                },
                {name: 'è´´å§çƒ­æ¦œ', logoClass: 'tieba-logo', hotList: [], type: 'tieba', isLoading: true, error: false},
                {
                    name: 'å¤´æ¡çƒ­æ¦œ',
                    logoClass: 'toutiao-logo',
                    hotList: [],
                    type: 'toutiao',
                    isLoading: true,
                    error: false
                }
            ]
        },
        methods: {
            // åˆå§‹åŒ–å‡½æ•°
            init() {
                this.platforms.forEach(platform => {
                    this.loadPlatformData(platform);
                });
            },

            // è·å–çƒ­æ¦œæ•°æ®
            loadPlatformData(platform) {
                const self = this;
                axios.get(`http://117.72.117.19:9782/hotSearch/queryByType/${platform.type}`)
                    .then(response => {
                        platform.hotList = response.data.data;
                        platform.isLoading = false;
                        platform.error = false;
                        console.log(`${platform.name} æ•°æ®:`, response.data.data);
                    })
                    .catch(error => {
                        platform.isLoading = false;
                        platform.error = true;
                        console.error(`è·å–${platform.name}æ•°æ®å¤±è´¥`, error);
                    });
            },

            // æ ¼å¼åŒ–çƒ­æ¦œå€¼
            formatHotValue(value) {
                if (value > 10000) {
                    return (value / 10000).toFixed(1) + 'ä¸‡';
                }
                return value;
            },

            // åˆ‡æ¢ä¸»é¢˜
            toggleTheme() {
                const body = document.body;
                const themeIcon = document.getElementById('theme-icon');

                if (body.classList.contains('dark-theme')) {
                    body.classList.remove('dark-theme');
                    themeIcon.textContent = 'ğŸŒ'; // åˆ‡æ¢åˆ°å¤ªé˜³å›¾æ ‡
                    // ä¿å­˜ä¸»é¢˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('appTheme', 'light');
                } else {
                    body.classList.add('dark-theme');
                    themeIcon.textContent = 'ğŸŒ™'; // åˆ‡æ¢åˆ°æœˆäº®å›¾æ ‡
                    // ä¿å­˜ä¸»é¢˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('appTheme', 'dark');
                }
            },
        }
    });
</script>
</body>
</html>